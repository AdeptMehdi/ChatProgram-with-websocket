---
/**
 * @fileoverview Main Chat component.
 * Handles the UI and client-side Socket.io integration.
 */
---

<div id="lobby-container">
    <header>
        <div class="lobby-header">
            <h1><i class="fa-solid fa-comments"></i> Chat Lobby</h1>
            <p>Join an existing room or create your own space</p>
        </div>
    </header>
    <div class="lobby-body">
        <div class="rooms-section">
            <h3><i class="fa-solid fa-layer-group"></i> Active Rooms</h3>
            <div id="rooms-list" class="rooms-list">
                <div class="loading-rooms">Connecting to server...</div>
            </div>
        </div>
        <div class="lobby-footer">
            <button id="create-room-btn" class="primary-btn">
                <i class="fa-solid fa-plus"></i> Create New Room
            </button>
        </div>
    </div>
</div>

<div id="chat-container" style="display: none;">
    <header>
        <div class="room-info">
            <button id="toggle-users" class="icon-btn mobile-only">
                <i class="fa-solid fa-users"></i>
            </button>
            <h2 id="room-name">Room: <span id="current-room">...</span></h2>
        </div>
        <div class="user-info">
            <span id="current-user">Not joined</span>
            <button id="leave-btn" class="small-btn">Leave</button>
        </div>
    </header>

    <div class="chat-body">
        <div id="messages">
            <!-- Messages will be injected here -->
        </div>

        <aside class="sidebar">
            <h3>Users Online</h3>
            <ul id="user-list" class="user-list">
                <!-- User list will be injected here -->
            </ul>
        </aside>
    </div>

    <footer>
        <div id="typing-indicator"></div>
        <form id="chat-form" class="input-area">
            <input 
                type="text" 
                id="message-input" 
                placeholder="Type a message..." 
                autocomplete="off"
                required
            />
            <button type="submit">
                <i class="fa-solid fa-paper-plane"></i> Send
            </button>
        </form>
    </footer>
</div>

<script>
    import { io } from 'socket.io-client';
    import Swal from 'sweetalert2';
    
    if (typeof window !== 'undefined') {
        let socket: any;
        let username: string;
        let room: string;
        let userRole: string;
        let typingTimeout: any;

        const lobbyContainer = document.getElementById('lobby-container') as HTMLDivElement;
        const chatContainer = document.getElementById('chat-container') as HTMLDivElement;
        const roomsListDiv = document.getElementById('rooms-list') as HTMLDivElement;
        const createRoomBtn = document.getElementById('create-room-btn') as HTMLButtonElement;

        const chatForm = document.getElementById('chat-form') as HTMLFormElement;
        const messageInput = document.getElementById('message-input') as HTMLInputElement;
        const messagesDiv = document.getElementById('messages') as HTMLDivElement;
        const userListUl = document.getElementById('user-list') as HTMLUListElement;
        const roomNameSpan = document.getElementById('current-room') as HTMLSpanElement;
        const currentUserSpan = document.getElementById('current-user') as HTMLSpanElement;
        const leaveBtn = document.getElementById('leave-btn') as HTMLButtonElement;
        const typingIndicator = document.getElementById('typing-indicator') as HTMLDivElement;
        const toggleUsersBtn = document.getElementById('toggle-users') as HTMLButtonElement;
        const sidebar = document.querySelector('.sidebar') as HTMLElement;

        // Toggle sidebar on mobile
        toggleUsersBtn?.addEventListener('click', () => {
            sidebar.classList.toggle('active');
        });

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 768 && 
                !sidebar.contains(e.target as Node) && 
                !toggleUsersBtn.contains(e.target as Node) && 
                sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        });

        // Initialize socket immediately to get room updates
        socket = io('http://localhost:4000');

        socket.on('roomsList', (rooms: any[]) => {
            renderRoomsList(rooms);
        });

        const renderRoomsList = (rooms: any[]) => {
            if (rooms.length === 0) {
                roomsListDiv.innerHTML = '<div class="no-rooms">No active rooms. Be the first to create one!</div>';
                return;
            }

            roomsListDiv.innerHTML = '';
            rooms.forEach(r => {
                const roomEl = document.createElement('div');
                roomEl.className = 'room-card';
                roomEl.innerHTML = `
                    <div class="room-details">
                        <span class="room-name">${r.name}</span>
                        <span class="room-users"><i class="fa-solid fa-users"></i> ${r.count} users</span>
                    </div>
                    <button class="join-btn" data-room="${r.name}">Join Room</button>
                `;
                roomsListDiv.appendChild(roomEl);
            });

            // Add listeners to join buttons
            document.querySelectorAll('.join-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const roomToJoin = (e.target as HTMLButtonElement).getAttribute('data-room');
                    if (roomToJoin) handleJoinRequest(roomToJoin);
                });
            });
        };

        const handleJoinRequest = async (roomName?: string) => {
            const { value: name } = await Swal.fire({
                title: 'Enter Username',
                input: 'text',
                inputLabel: 'What should we call you?',
                inputPlaceholder: 'Username',
                showCancelButton: true,
                inputValidator: (value) => {
                    if (!value) return 'You need to write something!';
                    return null;
                }
            });

            if (name) {
                username = name;
                if (roomName) {
                    room = roomName;
                    joinRoom();
                } else {
                    // This was a "Create Room" request
                    const { value: newRoomName } = await Swal.fire({
                        title: 'Create New Room',
                        input: 'text',
                        inputLabel: 'Room Name',
                        inputPlaceholder: 'Enter room name...',
                        showCancelButton: true,
                        inputValidator: (value) => {
                            if (!value) return 'Room name cannot be empty!';
                            return null;
                        }
                    });
                    if (newRoomName) {
                        room = newRoomName;
                        joinRoom();
                    }
                }
            }
        };

        const joinRoom = () => {
            socket.emit('join', { username, room }, (response: any) => {
                if (response.error) {
                    Swal.fire('Error', response.error, 'error');
                } else {
                    userRole = response.role;
                    lobbyContainer.style.display = 'none';
                    chatContainer.style.display = 'flex';
                    roomNameSpan.textContent = room;
                    currentUserSpan.textContent = `Logged in as: ${username} (${userRole})`;
                    setupChatListeners();
                }
            });
        };

        const setupChatListeners = () => {
            socket.on('message', (message: any) => {
                appendMessage(message);
            });

            socket.on('roomData', ({ users }: any) => {
                renderUserList(users);
            });

            socket.on('kicked', () => {
                Swal.fire('Kicked', 'You have been kicked from the room.', 'error').then(() => {
                    location.reload();
                });
            });

            socket.on('userTyping', ({ username: typingUser, isTyping }: any) => {
                if (isTyping) {
                    typingIndicator.textContent = `${typingUser} is typing...`;
                } else {
                    typingIndicator.textContent = '';
                }
            });
        };

        createRoomBtn.addEventListener('click', () => handleJoinRequest());

        const appendMessage = (message: any) => {
            const messageElement = document.createElement('div');
            const isSelf = message.user === username;
            const isSystem = message.user === 'system';

            messageElement.classList.add('message');
            if (isSystem) {
                messageElement.classList.add('system');
            } else {
                messageElement.classList.add(isSelf ? 'self' : 'other');
            }

            const time = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            messageElement.innerHTML = `
                ${!isSystem ? `
                    <div class="message-info">
                        <strong><i class="fa-solid fa-user-circle"></i> ${message.user}</strong>
                        <span>${time}</span>
                    </div>
                ` : ''}
                <div class="message-text">${message.text}</div>
            `;

            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        };

        const renderUserList = (users: any[]) => {
            userListUl.innerHTML = '';
            users.forEach(user => {
                const li = document.createElement('li');
                li.className = 'user-item';
                if (user.role === 'admin') li.classList.add('admin-item');
                if (user.isMuted) li.classList.add('muted-item');

                li.innerHTML = `
                    <i class="fa-solid fa-circle-user" style="color: ${user.role === 'admin' ? '#fbbf24' : 'var(--accent)'}"></i>
                    <div class="user-details">
                        <span>${user.username} ${user.id === socket.id ? '(You)' : ''}</span>
                        <small>${user.role}${user.isMuted ? ' | Muted' : ''}</small>
                    </div>
                    <span class="user-status"></span>
                `;

                if (userRole === 'admin' && user.id !== socket.id) {
                    li.style.cursor = 'pointer';
                    li.addEventListener('click', () => showActionMenu(user));
                }

                userListUl.appendChild(li);
            });
        };

        const showActionMenu = (targetUser: any) => {
            Swal.fire({
                title: `Manage ${targetUser.username}`,
                text: 'Select an action to perform',
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: targetUser.isMuted ? 'Unmute' : 'Mute',
                denyButtonText: 'Kick',
                showDenyButton: true,
                footer: targetUser.role !== 'admin' ? '<button id="promote-btn" class="swal2-confirm swal2-styled" style="background-color: #fbbf24">Promote to Admin</button>' : '',
                didOpen: () => {
                    const promoteBtn = document.getElementById('promote-btn');
                    if (promoteBtn) {
                        promoteBtn.onclick = () => {
                            socket.emit('admin:promote', targetUser.id);
                            Swal.close();
                        };
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    socket.emit('admin:mute', targetUser.id);
                } else if (result.isDenied) {
                    socket.emit('admin:kick', targetUser.id);
                }
            });
        };

        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (text && socket) {
                socket.emit('sendMessage', text, () => {
                    messageInput.value = '';
                    messageInput.focus();
                });
            }
        });

        messageInput.addEventListener('input', () => {
            if (socket) {
                socket.emit('typing', true);
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    socket.emit('typing', false);
                }, 2000);
            }
        });

        leaveBtn.addEventListener('click', () => {
            location.reload();
        });

        socket.on('disconnect', () => {
            Swal.fire('Disconnected', 'Lost connection to server.', 'warning');
        });
    }
</script>

<style>
    .small-btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
        margin-left: 1rem;
        background-color: var(--error-color);
    }
    .small-btn:hover {
        background-color: #dc2626;
    }
</style>
